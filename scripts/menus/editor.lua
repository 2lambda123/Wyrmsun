--
--	editor-unit-types a sorted list of unit-types for the editor.
--	FIXME: this is only a temporary hack, for better sorted units.
--
editor_types = {

	"unit-germanic-worker",
	"unit-germanic-warrior",
--	"unit-germanic-spearman",
	"unit-germanic-archer",
	"unit-germanic-town-hall",
	"unit-germanic-farm",
	"unit-germanic-barracks",
	"unit-germanic-carpenters-shop",
	"unit-germanic-smithy",

--- - - - - - - - - - - - - - - - - - -

	"unit-teuton-worker",
	"unit-teuton-swordsman",
	"unit-teuton-spearman",
	"unit-teuton-archer",
	"unit-teuton-ritter",
	"unit-teuton-catapult",
	"unit-teuton-kogge",
	"unit-teuton-town-hall",
	"unit-teuton-stronghold",
	"unit-teuton-farm",
	"unit-teuton-barracks",
	"unit-teuton-lumber-mill",
	"unit-teuton-smithy",
	"unit-teuton-stables",
	"unit-teuton-watch-tower",
	"unit-teuton-guard-tower",
	"unit-teuton-dock",

	"unit-suebi-swordsman",

	"unit-frank-swordsman",
	"unit-frank-spearman",
	"unit-frank-horseman",

--- - - - - - - - - - - - - - - - - - -

	"unit-celt-farm",
	
--- - - - - - - - - - - - - - - - - - -

	"unit-dwarven-miner",
	"unit-dwarven-militia",
	"unit-dwarven-axefighter",
	"unit-dwarven-steelclad",
	"unit-dwarven-thane",
	"unit-dwarven-guard",
	"unit-dwarven-scout",
	"unit-dwarven-pathfinder",
	"unit-dwarven-yale-rider",
	"unit-dwarven-gryphon-rider",
	"unit-dwarven-ballista",
	"unit-dwarven-transport-ship",

	"unit-dwarven-town-hall",
	"unit-dwarven-stronghold",
	"unit-dwarven-mushroom-farm",
	"unit-dwarven-barracks",
	"unit-dwarven-lumber-mill",
	"unit-dwarven-smithy",
	"unit-dwarven-yale-pen",
	"unit-dwarven-sentry-tower",
	"unit-dwarven-guard-tower",
	"unit-dwarven-dock",

	"unit-brising-miner",
	"unit-brising-militia",
	"unit-brising-transport-ship",
	"unit-brising-town-hall",
	"unit-brising-stronghold",
	"unit-brising-smithy",

	"unit-surghan-mercenary-steelclad",
	"unit-surghan-mercenary-thane",

--- - - - - - - - - - - - - - - - - - -

	"unit-gnomish-worker",
	"unit-gnomish-recruit",
	"unit-gnomish-duelist",
	"unit-gnomish-master-at-arms",
	"unit-gnomish-herbalist",
	"unit-gnomish-caravan",

	"unit-gnomish-town-hall",
	"unit-gnomish-farm",
	"unit-gnomish-barracks",

--- - - - - - - - - - - - - - - - - - -

	"unit-goblin-worker",
	"unit-goblin-swordsman",
	"unit-goblin-spearman",
	"unit-goblin-archer",
	"unit-goblin-headhunter",
	"unit-goblin-thief",
	"unit-goblin-war-machine",
	"unit-goblin-glider",

	"unit-goblin-town-hall",
	"unit-goblin-farm",
	"unit-goblin-mess-hall",
	"unit-goblin-lumber-mill",
	"unit-goblin-smithy",

--- - - - - - - - - - - - - - - - - - -

	"unit-kobold-footpad",

--- - - - - - - - - - - - - - - - - - -

	"unit-gold-rock",
	"unit-gold-deposit",
	"unit-gold-mine",
	"unit-silver-rock",
	"unit-silver-deposit",
	"unit-silver-mine",
	"unit-copper-rock",
	"unit-copper-deposit",
	"unit-copper-mine",
	"unit-wood-pile",
	"unit-coal-mine",
	"unit-mercenary-camp",
	"unit-tree-stump",
	"unit-hole",
	"unit-raft",

--- - - - - - - - - - - - - - - - - - -

	"unit-worm",
	"unit-bug",
	"unit-bee",
	"unit-fly",
	"unit-snail",
	"unit-slug",
	"unit-frog",
	"unit-wyrm",
	"unit-bird",
	"unit-crow",
	"unit-gryphon",
	"unit-rat",
	"unit-bat",
	"unit-blood-bat",
	"unit-dread-bat",
	"unit-yale",
	"unit-horse",
	"unit-slime",
	"unit-long-swordsman",

--- - - - - - - - - - - - - - - - - - -

	"unit-gold-coins",
	"unit-gold-sack",
	"unit-gold-chest",
	"unit-gold-and-gems-chest",
	"unit-potion-of-healing",
	"unit-potion-of-decay",
	"unit-potion-of-slowness",
	"unit-cheese",
	"unit-carrots",
	"unit-gryphon-feather",
	"unit-scroll",
	"unit-short-sword",
	"unit-broad-sword",
	"unit-spatha",
	"unit-frankish-spatha",
	"unit-thrusting-sword",
	"unit-battle-axe",
	"unit-broad-axe",
	"unit-great-axe",
	"unit-hammer",
	"unit-mining-pick",
	"unit-short-spear",
	"unit-long-spear",
	"unit-pike",
	"unit-throwing-axe",
	"unit-sharp-throwing-axe",
	"unit-bearded-throwing-axe",
	"unit-wooden-shield",
	"unit-bronze-shield",
	"unit-iron-shield",
	"unit-kite-shield",
	"unit-round-shield",
	"unit-brising-round-shield",
	"unit-heater-shield",
	"unit-thrymgjol-shield",
	"unit-boots",
	"unit-wool-shoes",
	"unit-furry-wool-shoes",
	"unit-ring",
	"unit-amulet",
	"unit-arrows",
	"unit-barbed-arrows",
	"unit-bodkin-arrows",
	"unit-scepter-of-fire",
	"unit-caltrops",
	"unit-trap",
	
--- - - - - - - - - - - - - - - - - - -

	"unit-glyph",
	"unit-goblin-banner",
	"unit-barrel",
	"unit-door",
	"unit-chair",
	"unit-table",
	"unit-alchemy-bench",
	"unit-bed",
	"unit-stairs",
	"unit-mushroom",
	"unit-mushroom-patch",
	"unit-flowers",
	"unit-large-flower",
	"unit-fern",
	"unit-twigs",
	"unit-log",
	"unit-small-rocks",
	"unit-stalagmites",
	"unit-bones",
	"unit-wyrm-skeleton",
	"unit-volcanic-crater",
	"unit-roaming-fog-small",
	"unit-roaming-fog",
	"unit-miasma",
	"unit-floor-decoration",
	"unit-shelf",
	"unit-outer-wall-decoration",
	"unit-inner-wall-decoration"
}

editor_tilesets = { "cave", "conifer_forest_summer", "conifer_forest_autumn", "dungeon", "fairlimbed_forest", "swamp"}

--  Menu for new map to edit
local function RunEditorNewMapMenu()
	local menu = WarMenu()
	local offx = (Video.Width - 640) / 2
	local offy = (Video.Height - 480) / 2
	local tilesets = editor_tilesets
	local mapSizes = {"32", "64", "96", "128", "256"}

	menu:addLabel("Map Description:", offx + 208, offy + 104 + 32 * 0, Fonts["game"], false)
	local mapDescription = menu:addTextInputField("", offx + 208, offy + 104 + 32 * 1, 200)
	menu:addLabel("Terrain:", offx + 208, offy + 104 + 32 * 2, Fonts["game"], false)
	local dropDownTileset = menu:addDropDown(editor_tilesets, offx + 208 + 60, offy + 104 + 32 * 2, function() end)
	dropDownTileset:setSize(152, 20)

	menu:addLabel("Size:", offx + 208, offy + 104 + 32 * 3, Fonts["game"], false)
	local mapSizex = menu:addDropDown(mapSizes, offx + 208 + 50, offy + 104 + 32 * 3, function() end)
	mapSizex:setSize(50, 20)
	menu:addLabel("x", offx + 208 + 110, offy + 104 + 32 * 3, Fonts["game"], false)
	local mapSizey = menu:addDropDown(mapSizes, offx + 208 + 125, offy + 104 + 32 * 3, function() end)
	mapSizey:setSize(50, 20)

	menu:addFullButton(_("~!New Map"), "n", offx + 208, offy + 104 + 36 * 5,
	function()
		-- TODO : check value
		Map.Info.Description = mapDescription:getText()
		Map.Info.MapWidth = mapSizes[1 + mapSizex:getSelected()]
		Map.Info.MapHeight = mapSizes[1 + mapSizey:getSelected()]
		if (CanAccessFile("scripts/tilesets/" .. string.gsub(editor_tilesets[1 + dropDownTileset:getSelected()], "-", "_") .. ".lua")) then
			LoadTileModels("scripts/tilesets/" .. string.gsub(editor_tilesets[1 + dropDownTileset:getSelected()], "-", "_") .. ".lua")
		else -- if the tileset doesn't exist in the base game, check if any enabled mod has this tileset
			for i=1,table.getn(Mods) do
				if (CanAccessFile(string.gsub(Mods[i], "info.lua", "scripts/tilesets/") .. string.gsub(editor_tilesets[1 + dropDownTileset:getSelected()], "-", "_") .. ".lua")) then
					LoadTileModels(string.gsub(Mods[i], "info.lua", "scripts/tilesets/") .. string.gsub(editor_tilesets[1 + dropDownTileset:getSelected()], "-", "_") .. ".lua")
					break
				end
			end
		end
		menu:stop()
		StartEditor(nil, false)
		RunEditorMenu()
	end)
	menu:addFullButton(_("~!Cancel"), "c", offx + 208, offy + 104 + 36 * 6, function() menu:stop(1); RunEditorMenu() end)
	return menu:run()
end

-- Menu for loading map to edit
local function RunEditorLoadMapMenu(is_mod)
	local menu = WarMenu()
	local offx = (Video.Width - 640) / 2
	local offy = (Video.Height - 480) / 2
	local labelMapName
	local labelDescription
	local labelNbPlayer
	local labelMapSize
	local edit_button
	
	-- update label content
	local function MapChanged()
		if not (is_mod) then
			labelMapName:setCaption("File: " .. string.sub(mapname, 6))
			labelMapName:adjustSize()
		
			labelNbPlayer:setCaption("Players: " .. mapinfo.nplayers)
			labelNbPlayer:adjustSize()

			labelDescription:setCaption("Scenario: " .. _(mapinfo.description))
			labelDescription:adjustSize()

			labelMapSize:setCaption("Size: " .. mapinfo.w .. " x " .. mapinfo.h)
			labelMapSize:adjustSize()
		else
			if (modname ~= "") then
				labelMapName:setCaption("File: " .. string.sub(modname, 6))
				edit_button:setEnabled(true)
			else
				labelMapName:setCaption("")
				edit_button:setEnabled(false)
			end
			labelMapName:adjustSize()
		end
	end

	labelMapName = menu:addLabel("", offx + 208, offy + 104 + 36 * 0, Fonts["game"], false)
	labelDescription = menu:addLabel("", offx + 208, offy + 104 + 32 * 1, Fonts["game"], false)
	labelNbPlayer = menu:addLabel("", offx + 208, offy + 104 + 32 * 2, Fonts["game"], false)
	labelMapSize = menu:addLabel("", offx + 208, offy + 104 + 32 * 3, Fonts["game"], false)

	local select_button_string
	if not (is_mod) then
		select_button_string = _("~!Select Map")
	else
		select_button_string = _("~!Select Mod")
	end
	menu:addFullButton(select_button_string, "s", offx + 208, offy + 104 + 36 * 4,
		function()
			if not (is_mod) then
				local oldmapname = mapname
				RunSelectScenarioMenu(is_mod)
				if (mapname ~= oldmapname) then
					GetMapInfo(mapname)
					MapChanged()
				end
			else
				local oldmapname = modname
				RunSelectScenarioMenu(is_mod)
				if (modname ~= oldmapname) then
					GetMapInfo(modname)
					MapChanged()
				end
			end
		end)

	if not (is_mod) then
		edit_button = menu:addFullButton(_("~!Edit Map"), "e", offx + 208, offy + 104 + 36 * 5, function() menu:stop(); StartEditor(mapname, false); RunEditorMenu() end)
	else
		edit_button = menu:addFullButton(_("~!Edit Mod"), "e", offx + 208, offy + 104 + 36 * 5, function() menu:stop();
			Map.Info.MapWidth = 32
			Map.Info.MapHeight = 32
			LoadTileModels("scripts/tilesets/" .. string.gsub(editor_tilesets[1], "-", "_") .. ".lua")
			StartEditor(modname, true);
		RunEditorMenu() end)
	end
	menu:addFullButton(_("~!Cancel"), "c", offx + 208, offy + 104 + 36 * 6, function() menu:stop(1); RunEditorMenu() end)

	if not (is_mod) then
		GetMapInfo(mapname)
	else
		GetMapInfo(modname)
	end
	MapChanged()
	return menu:run()
end

-- root of the editor menu
function RunEditorMenu()
	SetPlayerData(GetThisPlayer(), "RaceName", "gnome")

	if not (IsMusicPlaying()) then
		PlayMusicName("MenuTheme")
	end

	local menu = WarMenu()
	local offx = (Video.Width - 640) / 2
	local offy = (Video.Height - 480) / 2

	menu:addLabel(_("~<Map Editor~>"), offx + 320, offy + 212 - 25)
	local buttonNewMap =
	menu:addFullButton(_("~!New Map"), "n", offx + 208, offy + 104 + 36*3, function() RunEditorNewMapMenu(); menu:stop() end)
	menu:addFullButton(_("~!Load Map"), "l", offx + 208, offy + 104 + 36*4, function() RunEditorLoadMapMenu(false); menu:stop() end)
	menu:addFullButton(_("Load ~!Mod"), "m", offx + 208, offy + 104 + 36*5, function() RunEditorLoadMapMenu(true); menu:stop() end)
	menu:addFullButton(_("~!Cancel"), "c", offx + 208, offy + 104 + 36*6, function() menu:stop() end)
	return menu:run()
end

function RunEditorSaveMap(browser, name, menu, save_as_mod)
	local saved = EditorSaveMap(browser.path .. name, save_as_mod)
	if (saved == -1) then
		local confirm = WarGameMenu(panel(3))
		confirm:resize(300,120)
		if not (save_as_mod) then
			confirm:addLabel("Cannot save map to file:", 300 / 2, 11)
		else
			confirm:addLabel("Cannot save mod to file:", 300 / 2, 11)
		end
		confirm:addLabel(browser.path .. name, 300 / 2, 31)
		confirm:addHalfButton("~!OK", "o", 1 * (300 / 3), 120 - 16 - 27, function() confirm:stop() end)
		confirm:run(false)
	else
		if not (save_as_mod) then
			UI.StatusLine:Set("Saved map to: " .. browser.path .. name)
		else
			UI.StatusLine:Set("Saved mod to: " .. browser.path .. name)
		end
		menu:stop()
	end
end

--
--  Save map from the editor
--
function RunEditorSaveMenu(save_as_mod)
	if not (save_as_mod) then
		local map_has_person_player = false
		for i = 0, 14 do
			if (Map.Info.PlayerType[i] == 5) then
				map_has_person_player = true
				break
			end
		end
		if not (map_has_person_player) then
			GenericDialog("Error", "A map needs to have at least one person player.")
			return
		end
	end
	
	local menu = WarGameMenu(panel(3))

	menu:resize(384, 256)

	if not (save_as_mod) then
		menu:addLabel("Save Map", 384 / 2, 11)
	else
		menu:addLabel("Save as Mod", 384 / 2, 11)
	end

	local t
	local browser
	if not (save_as_mod) then
		t = menu:addTextInputField("map.smp",
			(384 - 300 - 18) / 2, 11 + 24, 318)

		browser = menu:addBrowser(MapDirectories[1], ".smp$",
			(384 - 300 - 18) / 2, 11 + 24 + 22, 318, 126)
	else
		t = menu:addTextInputField("mod.smp.gz",
			(384 - 300 - 18) / 2, 11 + 24, 318)

		browser = menu:addBrowser(ModDirectories[1], ".smp.gz$",
			(384 - 300 - 18) / 2, 11 + 24 + 22, 318, 126, nil, false)
	end

	local function cb(s)
		t:setText(browser:getSelectedItem())
	end
	browser:setActionCallback(cb)

	menu:addHalfButton(_("~!Cancel"), "c", 384 - ((384 - 300 - 18) / 2) - 106, 256 - 16 - 27, function() menu:stop() end)
	menu:addHalfButton("~!Save", "s", (384 - 300 - 18) / 2, 256 - 16 - 27,
	function()
		local name = t:getText()
		-- check for an empty string
		if (string.len(name) == 0) then
			return
		end
		-- append .smp
		if not (save_as_mod) then
			if (string.find(name, ".smp$") == nil) then
				name = name .. ".smp"
			end
		else
			if (string.find(name, ".smp.gz$") == nil) then
				name = name .. ".smp.gz"
			end
		end
		
		-- replace invalid chars with underscore
		local t = {"\\", "/", ":", "*", "?", "\"", "<", ">", "|"}
		table.foreachi(t, function(k,v) name = string.gsub(name, v, "_") end)

		if (browser:exists(name)) then
			local confirm = WarGameMenu(panel(3))
			confirm:resize(300,120)
			confirm:addLabel(name, 300 / 2, 11)
			confirm:addLabel("File exists, are you sure ?", 300 / 2, 31)
			confirm:addHalfButton("~!Yes", "y", 1 * (300 / 3) - 90, 120 - 16 - 27,
			function()
				confirm:stop()
				RunEditorSaveMap(browser, name, menu, save_as_mod)
			end)
			confirm:addHalfButton("~!No", "n", 3 * (300 / 3) - 116, 120 - 16 - 27, function() confirm:stop() end)
			confirm:run(false)
		else
			RunEditorSaveMap(browser, name, menu, save_as_mod)
		end
	end)
	
	local sortByCheckBox
	sortByCheckBox = menu:addImageCheckBox(_("Show Latest First"), (384 - 300 - 18) / 2, 256 - 16 - 27 - 25,
	function()
		wyr.preferences.SortSaveGamesByTime = sortByCheckBox:isMarked()
		SavePreferences()

		if (wyr.preferences.SortSaveGamesByTime) then
			browser:sortByTime()
		else
			browser:sortByName()
		end
	end)
	sortByCheckBox:setMarked(wyr.preferences.SortSaveGamesByTime)
	if (wyr.preferences.SortSaveGamesByTime) then
		browser:sortByTime()
	end

	menu:run(false)
end

--
--  Load a other map to edit.
--
function RunEditorLoadMenu()
-- TODO : fill this function correctly
--[[
--  RunSelectScenarioMenu()
--  if (buttonStatut == 1) then
--    EditorLoadMap(mapname)
--    StartEditor(mapname, false)
--  end
--]]
end

--
--  Change player properties from the editor
--
function RunEditorPlayerProperties()
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel("Player Properties", sizeX / 2, 11)

	local types = {"neutral", "nobody", "computer", "person", "rescue-passive", "rescue-active"}
	local civilization_names = GetCivilizations()
	local faction_list = {}
	local ais = { "passive", "land-attack", "northern-wastelands-goblins" }

	local player_list = {}
	local player_properties = {}
	for i = 1,15 do
		player_properties[i] = {}
		player_properties[i]["Type"] = Map.Info.PlayerType[i-1] - 2
		player_properties[i]["Civilization"] = Players[i-1].Race
		player_properties[i]["Faction"] = GetPlayerData(i-1, "Faction")
		player_properties[i]["AI"] = 0
		for j = 1,table.getn(ais) do
			if (ais[j] == Players[i-1].AiName) then player_properties[i].AI = j-1 end
		end
		player_properties[i]["Gold"] = Players[i-1].Resources[1]
		player_properties[i]["Lumber"] = Players[i-1].Resources[2]
		player_properties[i]["Stone"] = Players[i-1].Resources[5]
		table.insert(player_list, "Player " .. i)
	end
	
	local current_player
	local current_player_type
	local current_player_civilization
	local current_player_civilization_label
	local current_player_faction
	local current_player_faction_label
	local current_player_ai
	local current_player_ai_label
	local current_player_gold
	local current_player_gold_label
	local current_player_lumber
	local current_player_lumber_label
	local current_player_stone
	local current_player_stone_label
	
	local function PlayerChanged()
		current_player_type:setSelected(player_properties[current_player:getSelected() + 1].Type)
		current_player_civilization:setSelected(player_properties[current_player:getSelected() + 1].Civilization)
		
		faction_list = GetCivilizationFactionNames(civilization_names[current_player_civilization:getSelected() + 1])
		table.insert(faction_list, "")
		current_player_faction:setList(faction_list)
		current_player_faction:setSelected(GetElementIndexFromArray(faction_list, player_properties[current_player:getSelected() + 1].Faction) - 1)
		current_player_faction:setSize(236, 20)
		
		current_player_ai:setSelected(player_properties[current_player:getSelected() + 1].AI)
		current_player_gold:setText(player_properties[current_player:getSelected() + 1].Gold)
		current_player_lumber:setText(player_properties[current_player:getSelected() + 1].Lumber)
		current_player_stone:setText(player_properties[current_player:getSelected() + 1].Stone)
		local player_active = current_player_type:getSelected() ~= 1
		current_player_civilization:setVisible(player_active)
		current_player_civilization_label:setVisible(player_active)
		current_player_faction:setVisible(player_active)
		current_player_faction_label:setVisible(player_active)
		current_player_ai:setVisible(player_active)
		current_player_ai_label:setVisible(player_active)
		current_player_gold:setVisible(player_active)
		current_player_gold_label:setVisible(player_active)
		current_player_lumber:setVisible(player_active)
		current_player_lumber_label:setVisible(player_active)
		current_player_stone:setVisible(player_active)
		current_player_stone_label:setVisible(player_active)
	end

	current_player = menu:addDropDown(player_list, (sizeX / 2) - 60, 11 + (36 * 1), function(dd) PlayerChanged() end)
	current_player:setSize(120, 20)
		
	menu:addLabel(_("Type:"), 10, 14 + 36 * 2, Fonts["game"], false)
	current_player_type = menu:addDropDown(types, (sizeX / 2) - 60 - 10, 11 + 36 * 2, function(dd)
		player_properties[current_player:getSelected() + 1].Type = current_player_type:getSelected()
		PlayerChanged()
	end)
	current_player_type:setSize(236, 20)
	
	current_player_civilization_label = menu:addLabel(_("Civilization:"), 10, 14 + 36 * 3, Fonts["game"], false)
	current_player_civilization = menu:addDropDown(civilization_names, (sizeX / 2) - 60 - 10, 11 + 36 * 3, function(dd)
		player_properties[current_player:getSelected() + 1].Civilization = current_player_civilization:getSelected()
		PlayerChanged()
	end)
	current_player_civilization:setSize(236, 20)
	
	current_player_faction_label = menu:addLabel(_("Faction:"), 10, 14 + 36 * 4, Fonts["game"], false)
	current_player_faction = menu:addDropDown(faction_list, (sizeX / 2) - 60 - 10, 11 + 36 * 4, function(dd)
		player_properties[current_player:getSelected() + 1].Faction = faction_list[current_player_faction:getSelected() + 1]
	end)
	current_player_faction:setSize(236, 20)
	
	current_player_ai_label = menu:addLabel(_("AI:"), 10, 14 + 36 * 5, Fonts["game"], false)
	current_player_ai = menu:addDropDown(ais, (sizeX / 2) - 60 - 10, 11 + 36 * 5, function(dd)
		player_properties[current_player:getSelected() + 1].AI = current_player_ai:getSelected()
	end)
	current_player_ai:setSize(236, 20)
	
	current_player_gold_label = menu:addLabel(_("Gold:"), 10, 12 + 36 * 6, Fonts["game"], false)
	current_player_gold = menu:addTextInputField(player_properties[current_player:getSelected() + 1].Gold, (sizeX / 2) - 60 - 10, 11 + 36 * 6, 60)

	current_player_lumber_label = menu:addLabel(_("Lumber:"), (sizeX / 2) + 10, 12 + 36 * 6, Fonts["game"], false)
	current_player_lumber = menu:addTextInputField(player_properties[current_player:getSelected() + 1].Lumber, sizeX - 60 - 10, 11 + 36 * 6, 60)

	current_player_stone_label = menu:addLabel(_("Stone:"), 10, 12 + 36 * 7, Fonts["game"], false)
	current_player_stone = menu:addTextInputField(player_properties[current_player:getSelected() + 1].Stone, (sizeX / 2) - 60 - 10, 11 + 36 * 7, 60)

	local function listen()
		player_properties[current_player:getSelected() + 1].Gold = current_player_gold:getText()
		player_properties[current_player:getSelected() + 1].Lumber = current_player_lumber:getText()
		player_properties[current_player:getSelected() + 1].Stone = current_player_stone:getText()
	end
	local listener = LuaActionListener(listen)
	menu:addLogicCallback(listener)
	
	PlayerChanged()
	
	menu:addHalfButton("~!OK", "o", 20 + 48, sizeY - 40,
		function()
			for i = 0, 14 do
				Map.Info.PlayerType[i] = player_properties[i + 1].Type + 2
				Players[i].Race = player_properties[i + 1].Civilization
				SetPlayerData(i, "Faction", player_properties[i + 1].Faction)
				Players[i].AiName = ais[player_properties[i + 1].AI + 1]
				Players[i].Resources[1] = player_properties[i + 1].Gold
				Players[i].Resources[2] = player_properties[i + 1].Lumber
				Players[i].Resources[5] = player_properties[i + 1].Stone
			end
			menu:stop()
		end
	)

	menu:addHalfButton(_("~!Cancel"), "c", 130 + 48, sizeY - 40,
		function() menu:stop() end)

	menu:run(false)
end

--
--  Change player properties from the editor
--
function RunEditorMapProperties()
-- TODO : manage edition of all properties.
	local menu = WarGameMenu(panel(3))

	local sizeX = 384
	local sizeY = 256

	menu:resize(sizeX, sizeY)
	menu:addLabel("Map Properties", sizeX / 2, 11)

	menu:addLabel("Map Name: ", 45, 11 + 36, nil, false)
	local desc = menu:addTextInputField(Map.Info.Description, 15, 36 * 2, 350)

	menu:addLabel("Size: " .. Map.Info.MapWidth .. " x " .. Map.Info.MapHeight, 45, 36 * 3, nil, false)
--	menu:addLabel("Size : ", 15, 36 * 3, nil, false)
--	local sizeX = menu:addTextInputField(Map.Info.MapWidth, 75, 36 * 3, 50)
--	menu:addLabel(" x ", 130, 36 * 3, nil, false)
--	local sizeY = menu:addTextInputField(Map.Info.MapHeight, 160, 36 * 3, 50)

	menu:addLabel("Tileset: ", 45, 36 * 4, nil, false)

	local list = { "Cave", "Conifer Forest (Summer)", "Conifer Forest (Autumn)", "Dungeon", "Fairlimbed Forest", "Swamp"}
	for i=table.getn(list)+1, table.getn(editor_tilesets) do
		table.insert(list, FullyCapitalizeString(string.gsub(editor_tilesets[i], "_", " ")))
	end
	local dropDownTileset = menu:addDropDown(list, 130, 36 * 4, function() end)
	for i = 0,table.getn(list)-1 do
		if (list[1 + i] == Map.Tileset.Name) then dropDownTileset:setSelected(i)
		end
	end
	dropDownTileset:setEnabled(false) -- TODO : manage this properties
	dropDownTileset:setSize(152, 20)

	menu:addHalfButton("~!OK", "o", 1 * (sizeX / 3) - 106 - 10, sizeY - 16 - 27,
		function()
			Map.Info.Description = desc:getText()
			-- TODO : Add others properties
			menu:stop()
		end
	)

	menu:addHalfButton(_("~!Cancel"), "c", 3 * (sizeX / 3) - 106 - 10, sizeY - 16 - 27,
		function() menu:stop() end)

	menu:run(false)
end

--
--  Change language properties from the editor
--
function RunEditorLanguageProperties()
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel("Custom Language Words", sizeX / 2, 11)

	local word_type_list = {"noun", "verb", "adjective", "pronoun", "adverb", "conjunction", "adposition", "article"}
	local gender_list = {"masculine", "feminine", "neuter", "no-gender"}
	local name_type_list = {"person-male", "person-female", "unit-class-barracks", "unit-class-dock", "unit-class-farm", "unit-class-lumber-mill", "unit-class-smithy", "unit-class-stables", "unit-class-town-hall", "unit-class-watch-tower", "unit-class-siege-engine"}
	local word_junction_type_list = {"compound", "separate"}
	local affix_type_list = {"prefix", "infix", "suffix"}

	local language_ident_list = GetLanguages(true)
	RemoveElementFromArray(language_ident_list, "avestan")
	RemoveElementFromArray(language_ident_list, "basque")
	RemoveElementFromArray(language_ident_list, "etruscan")
	RemoveElementFromArray(language_ident_list, "greek")
	RemoveElementFromArray(language_ident_list, "illyrian")
	RemoveElementFromArray(language_ident_list, "minoan")
	RemoveElementFromArray(language_ident_list, "phrygian")
	RemoveElementFromArray(language_ident_list, "proto-slavic")
	RemoveElementFromArray(language_ident_list, "russian")
	RemoveElementFromArray(language_ident_list, "thracian")
	table.sort(language_ident_list)
	local language_list = {}
	for i=1,table.getn(language_ident_list) do
		table.insert(language_list, GetLanguageData(language_ident_list[i], "Name"))
	end
		
	local current_language
	local word_list = {}
	local word_properties = {}
	for i=1,table.getn(language_ident_list) do
		word_list[i] = GetLanguageData(language_ident_list[i], "MapWords")
	end
	for i=1,table.getn(language_ident_list) do
		word_properties[i] = {}
		for j=1,table.getn(word_list[i]) do
			word_properties[i][j] = {}
			word_properties[i][j].Type = GetLanguageWordData(language_ident_list[i], word_list[i][j], "Type")
			word_properties[i][j].Gender = GetLanguageWordData(language_ident_list[i], word_list[i][j], "Gender")
			word_properties[i][j].Meaning = GetLanguageWordData(language_ident_list[i], word_list[i][j], "Meaning")
			word_properties[i][j].NameTypes = GetLanguageWordData(language_ident_list[i], word_list[i][j], "NameTypes")
			word_properties[i][j].AffixNameTypes = {}
			for k=1,table.getn(word_junction_type_list) do
				word_properties[i][j].AffixNameTypes[k] = {}
				for n=1,table.getn(affix_type_list) do
					word_properties[i][j].AffixNameTypes[k][n] = GetLanguageWordData(language_ident_list[i], word_list[i][j], "AffixNameTypes", word_junction_type_list[k], affix_type_list[n])
				end
			end
		end
	end
	
	CleanLanguageMapWords()
	
	local word_type
	local word_type_label
	local gender
	local gender_label
	local meaning
	local meaning_label
	local name_type
	local name_type_checkbox
	local name_type_label
	local affix_name_type_word_junction_type
	local affix_name_type_affix_type
	local affix_name_type_checkbox
	
	local function NameTypeChanged()
		name_type_checkbox:setMarked(GetArrayIncludes(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].NameTypes, name_type_list[name_type:getSelected() + 1]))
		
		affix_name_type_checkbox:setMarked(GetArrayIncludes(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].AffixNameTypes[affix_name_type_word_junction_type:getSelected() + 1][affix_name_type_affix_type:getSelected() + 1], name_type_list[name_type:getSelected() + 1]))
	end
	
	local function WordTypeChanged()
		local has_gender = (word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Type == "noun" or word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Type == "article")

		if (has_gender) then
			if (word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Gender == "") then
				word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Gender = "neuter"
			end
			gender:setSelected(GetElementIndexFromArray(gender_list, word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Gender) - 1)
		else
			word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Gender = ""
			gender:setSelected(0)
		end
		
		gender:setVisible(has_gender)
		gender_label:setVisible(has_gender)		
	end
	
	local function WordChanged()
		word_type:setSelected(GetElementIndexFromArray(word_type_list, word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Type) - 1)
		
		WordTypeChanged()
		
		meaning:setText(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Meaning)
		
		NameTypeChanged()
	end
	
	local function LanguageChanged(new_word)
		current_word:setList(word_list[current_language:getSelected() + 1])
		current_word:setSize(120, 20)
		if (new_word == nil) then
			current_word:setSelected(0)
		else
			current_word:setSelected(GetElementIndexFromArray(word_list[current_language:getSelected() + 1], new_word) - 1)
		end
		
		local has_words = table.getn(word_list[current_language:getSelected() + 1]) > 0
		
		current_word:setVisible(has_words)
		word_type:setVisible(has_words)
		word_type_label:setVisible(has_words)
		meaning:setVisible(has_words)
		meaning_label:setVisible(has_words)
		name_type:setVisible(has_words)
		name_type_label:setVisible(has_words)
		name_type_checkbox:setVisible(has_words)
		affix_name_type_word_junction_type:setVisible(has_words)
		affix_name_type_affix_type:setVisible(has_words)
		affix_name_type_checkbox:setVisible(has_words)

		if (has_words) then
			WordChanged()
		else
			gender:setVisible(false)
			gender_label:setVisible(false)
		end		
	end

	current_language = menu:addDropDown(language_list, (sizeX / 2) - 60, 11 + (34 * 1), function(dd) LanguageChanged() end)
	current_language:setSize(120, 20)
	current_language:setSelected(0)
		
	current_word = menu:addDropDown(word_list[current_language:getSelected() + 1], (sizeX / 2) - 60, 11 + (34 * 2), function(dd) WordChanged() end)
	current_word:setSize(120, 20)
		
	word_type_label = menu:addLabel(_("Type:"), 10, 14 + 34 * 3, Fonts["game"], false)
	word_type = menu:addDropDown(word_type_list, (sizeX / 2) - 60 - 10, 11 + 34 * 3, function(dd)
		word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Type = word_type_list[word_type:getSelected() + 1]
		WordTypeChanged()
	end)
	word_type:setSize(236, 20)
	word_type:setSelected(0)

	meaning_label = menu:addLabel(_("Meaning:"), 10, 12 + 34 * 4, Fonts["game"], false)
	meaning = menu:addTextInputField("", (sizeX / 2) - 60 - 10, 11 + 34 * 4, 120)
			
	gender_label = menu:addLabel(_("Gender:"), 10, 14 + 34 * 5, Fonts["game"], false)
	gender = menu:addDropDown(gender_list, (sizeX / 2) - 60 - 10, 11 + 34 * 5, function(dd)
		word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Gender = gender_list[gender:getSelected() + 1]
	end)
	gender:setSize(236, 20)
	gender:setSelected(0)

	name_type_label = menu:addLabel(_("Name Types:"), 10, 14 + 34 * 6, Fonts["game"], false)
	name_type = menu:addDropDown(name_type_list, (sizeX / 2) - 60 - 10, 11 + 34 * 6, function(dd) NameTypeChanged() end)
	name_type:setSize(236 - 19 - 10, 20)
	name_type:setSelected(0)
	
	name_type_checkbox = menu:addImageCheckBox("", sizeX - 19 - 10, 11 + 34 * 6,
	function()
		if (name_type_checkbox:isMarked()) then
			if (GetArrayIncludes(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].NameTypes, name_type_list[name_type:getSelected() + 1]) == false) then
				table.insert(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].NameTypes, name_type_list[name_type:getSelected() + 1])
			end
		else
			RemoveElementFromArray(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].NameTypes, name_type_list[name_type:getSelected() + 1])
		end
	end)
	name_type_checkbox:setMarked(false)

	affix_name_type_word_junction_type = menu:addDropDown(word_junction_type_list, (sizeX / 2) - 60 - 10, 11 + 34 * 7, function(dd) NameTypeChanged() end)
	affix_name_type_word_junction_type:setSize(((236 - 19 - 10) / 2) - 1, 20)
	affix_name_type_word_junction_type:setSelected(0)
	
	affix_name_type_affix_type = menu:addDropDown(affix_type_list, (sizeX / 2) - 60 - 10 + ((236 - 19 - 10) / 2) + 2, 11 + 34 * 7, function(dd) NameTypeChanged() end)
	affix_name_type_affix_type:setSize(((236 - 19 - 10) / 2) - 1, 20)
	affix_name_type_affix_type:setSelected(0)
	
	affix_name_type_checkbox = menu:addImageCheckBox("", sizeX - 19 - 10, 11 + 34 * 7,
	function()
		if (affix_name_type_checkbox:isMarked()) then
			if (GetArrayIncludes(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].AffixNameTypes[affix_name_type_word_junction_type:getSelected() + 1][affix_name_type_affix_type:getSelected() + 1], name_type_list[name_type:getSelected() + 1]) == false) then
				table.insert(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].AffixNameTypes[affix_name_type_word_junction_type:getSelected() + 1][affix_name_type_affix_type:getSelected() + 1], name_type_list[name_type:getSelected() + 1])
			end
		else
			RemoveElementFromArray(word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].AffixNameTypes[affix_name_type_word_junction_type:getSelected() + 1][affix_name_type_affix_type:getSelected() + 1], name_type_list[name_type:getSelected() + 1])
		end
	end)
	affix_name_type_checkbox:setMarked(false)

	local function listen()
		local has_words = table.getn(word_list[current_language:getSelected() + 1]) > 0
		if (has_words) then
			word_properties[current_language:getSelected() + 1][current_word:getSelected() + 1].Meaning = meaning:getText()
		end
	end
	local listener = LuaActionListener(listen)
	menu:addLogicCallback(listener)
	
	LanguageChanged()
	
	menu:addFullButton("Crea~!te Word", "t", 176 - (224 / 2), sizeY - 36 * 2,
		function()
			local sub_menu = WarGameMenu(panel(3))
			sub_menu:setSize(384, 256)
			sub_menu:setPosition((Video.Width - sub_menu:getWidth()) / 2, (Video.Height - sub_menu:getHeight()) / 2)
			sub_menu:addLabel(_("Create Word"), 176, 11)
			
			local sub_sizeX = 384
			local sub_sizeY = 256

			sub_menu:addLabel(_("Word:"), 10, 12 + 36 * 1, Fonts["game"], false)
			local word_text = sub_menu:addTextInputField("", (sub_sizeX / 2) - 60 - 10, 11 + 36 * 1, 120)
			
			sub_menu:addFullButton("Crea~!te", "t", 176 - (224 / 2), sub_sizeY - 40 * 2,
				function()
					if (word_text:getText() == "") then
						GenericDialog("Error", "The word cannot be empty.")
					elseif (GetArrayIncludes(word_list[current_language:getSelected() + 1], word_text:getText()) or GetArrayIncludes(GetLanguageData(language_ident_list[current_language:getSelected() + 1], "Words"), word_text:getText())) then
						GenericDialog("Error", "There is already another word for that language spelled that way.")
					elseif (IsNameValidForWord(word_text:getText()) == false) then
						GenericDialog("Error", "The word is invalid.")
					else
						local new_word_id = table.getn(word_list[current_language:getSelected() + 1]) + 1
						word_list[current_language:getSelected() + 1][new_word_id] = word_text:getText()
						word_properties[current_language:getSelected() + 1][new_word_id] = {}
						word_properties[current_language:getSelected() + 1][new_word_id].Type = "noun"
						word_properties[current_language:getSelected() + 1][new_word_id].Meaning = ""
						word_properties[current_language:getSelected() + 1][new_word_id].Gender = "neuter"
						word_properties[current_language:getSelected() + 1][new_word_id].NameTypes = {}
						word_properties[current_language:getSelected() + 1][new_word_id].AffixNameTypes = {}
						for k=1,table.getn(word_junction_type_list) do
							word_properties[current_language:getSelected() + 1][new_word_id].AffixNameTypes[k] = {}
							for n=1,table.getn(affix_type_list) do
								word_properties[current_language:getSelected() + 1][new_word_id].AffixNameTypes[k][n] = {}
							end
						end
						
						LanguageChanged(word_text:getText())
						sub_menu:stop()
					end
				end
			)
			sub_menu:addFullButton("~!Cancel", "c", 176 - (224 / 2), sub_sizeY - 40 * 1,
				function()
					sub_menu:stop()
				end
			)
			sub_menu:run(false)
		end
	)
	
	menu:addHalfButton("~!OK", "o", 20 + 48, sizeY - 36 * 1,
		function()
			for i=1,table.getn(word_list) do
				for j=1,table.getn(word_list[i]) do
					local word_definition = {
						Language = language_ident_list[i],
						Type = word_properties[i][j].Type,
						NameTypes = word_properties[i][j].NameTypes,
						MapWord = true
					}
					if (word_properties[i][j].Meaning ~= "") then
						word_definition.Meanings = {word_properties[i][j].Meaning}
					end
					if (word_properties[i][j].Gender ~= "") then
						word_definition.Gender = word_properties[i][j].Gender
					end
					word_definition.AffixNameTypes = {}
					for k=1,table.getn(word_junction_type_list) do
						for n=1,table.getn(affix_type_list) do
							for o=1,table.getn(word_properties[i][j].AffixNameTypes[k][n]) do
								table.insert(word_definition.AffixNameTypes, word_junction_type_list[k])
								table.insert(word_definition.AffixNameTypes, affix_type_list[n])
								table.insert(word_definition.AffixNameTypes, word_properties[i][j].AffixNameTypes[k][n][o])
							end
						end
					end
					
					DefineLanguageWord(word_list[i][j], word_definition)
				end
			end
			menu:stop()
		end
	)

	menu:addHalfButton(_("~!Cancel"), "c", 130 + 48, sizeY - 36 * 1,
		function() menu:stop() end)

	menu:run(false)
end

--
--  Main menu in editor.
--
function RunInEditorMenu()
	local menu = WarGameMenu(panel(1))

	menu:addLabel("Editor Menu", 128, 11)

	menu:addFullButton("Save Map (~<F11~>)", "f11", 16, 40, function() RunEditorSaveMenu(false); end)
--	local buttonEditorLoad = -- To be removed when enabled.
--	menu:addFullButton("Load (~<F12~>)", "f12", 16, 40 + 35 * 1, RunEditorLoadMenu)
	menu:addFullButton("Save as ~!Mod", "m", 16, 40 + 35 * 1, function() RunEditorSaveMenu(true); end)
	menu:addFullButton("Map Properties (~<F5~>)", "f5", 16, 40 + 35 * 2, RunEditorMapProperties)
	menu:addFullButton("Player Properties (~<F6~>)", "f6", 16, 40 + 35 * 3, RunEditorPlayerProperties)
	menu:addFullButton("Custom ~!Language Words", "l", 16, 40 + 35 * 4, RunEditorLanguageProperties)

--	buttonEditorLoad:setEnabled(false) -- To be removed when enabled.

	menu:addFullButton("E~!xit to Menu", "x", 16, 40 + 35 * 5,
		function() Editor.Running = EditorNotRunning; menu:stopAll(); end)
	menu:addFullButton("Return to Editor (~<Esc~>)", "escape", 16, 40 + 35 * 6,
		function() menu:stop() end)

	menu:run(false)
end

--
--  Function to edit unit properties in the editor
--
function EditUnitProperties()

	if (GetUnitUnderCursor() == nil) then
		return;
	end
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel(_("Unit Properties"), sizeX / 2, 11)

	menu:addLabel(_("Unit Name"), sizeX / 2, 11 + (36 * 1))
	local name_value = menu:addTextInputField(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Name"), sizeX / 2 - 60, 11 + (36 * 2), 120)

	local trait_list = GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Traits")
	local prefix_list = GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Prefixes")
	local suffix_list = GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Suffixes")
	table.insert(trait_list, "") -- for if the unit has no trait
	table.insert(prefix_list, "") -- for if the unit has no prefix
	table.insert(suffix_list, "") -- for if the unit has no suffix

	local display_trait_list = {}
	local display_prefix_list = {}
	local display_suffix_list = {}
	
	for i=1,table.getn(trait_list) do
		table.insert(display_trait_list, tostring(string.gsub(trait_list[i], "upgrade%-", "")))
	end
	for i=1,table.getn(prefix_list) do
		table.insert(display_prefix_list, tostring(string.gsub(prefix_list[i], "upgrade%-item%-prefix%-", "")))
	end
	for i=1,table.getn(suffix_list) do
		table.insert(display_suffix_list, tostring(string.gsub(suffix_list[i], "upgrade%-item%-suffix%-", "")))
	end
	
	
	local unit_trait
	local unit_prefix
	local unit_suffix
	local activeCheckBox
	local resource = GetUnitUnderCursor().Type.GivesResource
	local resourceValue

	if (GetUnitBoolFlag(UnitNumber(GetUnitUnderCursor()), "organic") and table.getn(GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Traits")) > 0) then
		menu:addLabel(_("Unit Trait"), sizeX / 2, 11 + (36 * 3))
		unit_trait = menu:addDropDown(display_trait_list, (sizeX / 2) - 60, 11 + (36 * 4), function(dd) end)
		unit_trait:setSize(120, 20)
		unit_trait:setSelected(GetElementIndexFromArray(trait_list, GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Trait")) - 1)
	end

	if ((GetUnitBoolFlag(UnitNumber(GetUnitUnderCursor()), "Building") or GetUnitBoolFlag(UnitNumber(GetUnitUnderCursor()), "Item"))) then
		if (table.getn(GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Prefixes")) > 0) then
			menu:addLabel(_("Prefix"), sizeX / 4, 11 + (36 * 3))
			unit_prefix = menu:addDropDown(display_prefix_list, (sizeX / 4) - 60, 11 + (36 * 4), function(dd) end)
			unit_prefix:setSize(120, 20)
			unit_prefix:setSelected(GetElementIndexFromArray(prefix_list, GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Prefix")) - 1)
		end
		if (table.getn(GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Suffixes")) > 0) then
			menu:addLabel(_("Suffix"), math.floor(sizeX * 3 / 4), 11 + (36 * 3))
			unit_suffix = menu:addDropDown(display_suffix_list, math.floor(sizeX * 3 / 4) - 60, 11 + (36 * 4), function(dd) end)
			unit_suffix:setSize(120, 20)
			unit_suffix:setSelected(GetElementIndexFromArray(suffix_list, GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Suffix")) - 1)
		end
	end

	if (GetUnitUnderCursor().Type.GivesResource == 0) then
		menu:addLabel(_("Artificial Intelligence"), sizeX / 2, 11 + (36 * 5))
		activeCheckBox = menu:addImageCheckBox(_("Active"), sizeX / 2 - 30, 11 + (36 * 6))
		activeCheckBox:setMarked(GetUnitUnderCursor().Active)
	else
		menu:addLabel(_("Amount of") .. " " .. _(CapitalizeString(GetResourceNameById(resource))), sizeX / 2, 11 + (36 * 5))
		resourceValue = menu:addTextInputField(GetUnitUnderCursor().ResourcesHeld, sizeX / 2 - 30, 11 + (36 * 6), 60)
	end
	
	menu:addLabel(_("Hit Points:"), 10 + (sizeX / 4), 12 + 36 * 7, Fonts["game"], false)
	local hp_value = menu:addTextInputField(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "HitPoints"), (sizeX / 2) - 60 - 10 + (sizeX / 4), 11 + 36 * 7, 60)

	menu:addHalfButton(_("~!OK"), "o", 20 + 48, sizeY - 40,
		function()
			SetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Name", name_value:getText())
			if (GetUnitBoolFlag(UnitNumber(GetUnitUnderCursor()), "organic") and table.getn(GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Traits")) > 0) then
				if (trait_list[unit_trait:getSelected() + 1] ~= GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Trait")) then
					AcquireTrait(UnitNumber(GetUnitUnderCursor()), trait_list[unit_trait:getSelected() + 1])
				end
			end
			if (GetUnitBoolFlag(UnitNumber(GetUnitUnderCursor()), "Building") or GetUnitBoolFlag(UnitNumber(GetUnitUnderCursor()), "Item")) then
				if (table.getn(GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Prefixes")) > 0 and prefix_list[unit_prefix:getSelected() + 1] ~= GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Prefix")) then
					SetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Prefix", prefix_list[unit_prefix:getSelected() + 1])
				end
				if (table.getn(GetUnitTypeData(GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Ident"), "Suffixes")) > 0 and suffix_list[unit_suffix:getSelected() + 1] ~= GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Suffix")) then
					SetUnitVariable(UnitNumber(GetUnitUnderCursor()), "Suffix", suffix_list[unit_suffix:getSelected() + 1])
				end
			end
			if (GetUnitUnderCursor().Type.GivesResource ~= 0) then
				GetUnitUnderCursor().ResourcesHeld = resourceValue:getText();
			else
				GetUnitUnderCursor().Active = activeCheckBox:isMarked();
			end
			if (hp_value:getText() ~= GetUnitVariable(UnitNumber(GetUnitUnderCursor()), "HitPoints", "Max")) then
				SetUnitVariable(UnitNumber(GetUnitUnderCursor()), "HitPoints", tonumber(hp_value:getText()))
			end
			menu:stop()
		end
	)
		
	menu:addHalfButton(_("~!Cancel"), "c", 130 + 48, sizeY - 40,
		function() menu:stop() end)
	menu:run(false)
end


--
--  Function to edit unit type properties in the editor
--
function EditUnitTypeProperties(unit_type)

	if (unit_type == "" or unit_type == nil) then
		return;
	end
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel(_(GetUnitTypeName(unit_type)) .. " " .. _("Properties"), sizeX / 2, 11)

	menu:addFullButton(_("S~!tats"), "t", (sizeX / 2) - (224 / 2), sizeY - 40 - (36 * 6),
		function()
			EditUnitTypePropertiesStats(unit_type)
		end
	)
		
	menu:addFullButton(_("~!Resource Stats"), "r", (sizeX / 2) - (224 / 2), sizeY - 40 - (36 * 5),
		function()
			EditUnitTypePropertiesResourceStats(unit_type)
		end
	)
		
	menu:addFullButton(_("~!Sounds"), "s", (sizeX / 2) - (224 / 2), sizeY - 40 - (36 * 4),
		function()
			EditUnitTypePropertiesSounds(unit_type)
		end
	)
		
	menu:addFullButton(_("~!OK"), "o", (sizeX / 2) - (224 / 2), sizeY - 40 - (36 * 3),
		function()
			menu:stop()
		end
	)

	menu:run(false)
end

function EditUnitTypePropertiesStats(unit_type)

	if (unit_type == "" or unit_type == nil) then
		return;
	end
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel(_(GetUnitTypeName(unit_type)) .. " " .. _("Properties"), sizeX / 2, 11)

	menu:addLabel(_("Hit Points:"), 10, 12 + 36 * 1, Fonts["game"], false)
	local hp_value = menu:addTextInputField(GetUnitTypeData(unit_type, "HitPoints"), (sizeX / 2) - 60 - 10, 11 + 36 * 1, 60)

	menu:addLabel(_("Speed:"), (sizeX / 2) + 10, 12 + 36 * 1, Fonts["game"], false)
	local speed_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Speed"), sizeX - 60 - 10, 11 + 36 * 1, 60)

	menu:addLabel(_("Damage:"), 10, 12 + 36 * 2, Fonts["game"], false)
	local basic_damage_value = menu:addTextInputField(GetUnitTypeData(unit_type, "BasicDamage"), (sizeX / 2) - 60 - 10, 11 + 36 * 2, 60)

	menu:addLabel(_("Armor:"), (sizeX / 2) + 10, 12 + 36 * 2, Fonts["game"], false)
	local armor_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Armor"), sizeX - 60 - 10, 11 + 36 * 2, 60)

	menu:addLabel(_("Accuracy:"), 10, 12 + 36 * 3, Fonts["game"], false)
	local accuracy_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Accuracy"), (sizeX / 2) - 60 - 10, 11 + 36 * 3, 60)

	menu:addLabel(_("Evasion:"), (sizeX / 2) + 10, 12 + 36 * 3, Fonts["game"], false)
	local evasion_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Evasion"), sizeX - 60 - 10, 11 + 36 * 3, 60)

	menu:addLabel(_("Range:"), 10, 12 + 36 * 4, Fonts["game"], false)
	local range_value = menu:addTextInputField(GetUnitTypeData(unit_type, "AttackRange"), (sizeX / 2) - 60 - 10, 11 + 36 * 4, 60)

	menu:addLabel(_("Sight:"), (sizeX / 2) + 10, 12 + 36 * 4, Fonts["game"], false)
	local sight_value = menu:addTextInputField(GetUnitTypeData(unit_type, "SightRange"), sizeX - 60 - 10, 11 + 36 * 4, 60)

	menu:addLabel(_("Crit. Chance:"), 10, 12 + 36 * 5, Fonts["game"], false)
	local critical_strike_chance_value = menu:addTextInputField(GetUnitTypeData(unit_type, "CriticalStrikeChance"), (sizeX / 2) - 60 - 10, 11 + 36 * 5, 60)

	menu:addLabel(_("Backstab:"), (sizeX / 2) + 10, 12 + 36 * 5, Fonts["game"], false)
	local backstab_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Backstab"), sizeX - 60 - 10, 11 + 36 * 5, 60)

	menu:addLabel(_("Vs. Mounted:"), 10, 12 + 36 * 6, Fonts["game"], false)
	local bonus_against_mounted_value = menu:addTextInputField(GetUnitTypeData(unit_type, "BonusAgainstMounted"), (sizeX / 2) - 60 - 10, 11 + 36 * 6, 60)

	menu:addLabel(_("Thorns Dam.:"), (sizeX / 2) + 10, 12 + 36 * 6, Fonts["game"], false)
	local thorns_damage_value = menu:addTextInputField(GetUnitTypeData(unit_type, "ThornsDamage"), sizeX - 60 - 10, 11 + 36 * 6, 60)

	menu:addLabel(_("Day Sight:"), 10, 12 + 36 * 7, Fonts["game"], false)
	local day_sight_range_bonus_value = menu:addTextInputField(GetUnitTypeData(unit_type, "DaySightRangeBonus"), (sizeX / 2) - 60 - 10, 11 + 36 * 7, 60)

	menu:addLabel(_("Night Sight:"), (sizeX / 2) + 10, 12 + 36 * 7, Fonts["game"], false)
	local night_sight_range_bonus_value = menu:addTextInputField(GetUnitTypeData(unit_type, "NightSightRangeBonus"), sizeX - 60 - 10, 11 + 36 * 7, 60)

	menu:addHalfButton(_("~!OK"), "o", 20 + 48, sizeY - 40,
		function()
			if (hp_value:getText() ~= GetUnitTypeData(unit_type, "HitPoints")) then
				SetMapStat(unit_type, "HitPoints", hp_value:getText(), "Value")
				SetMapStat(unit_type, "HitPoints", hp_value:getText(), "Max")
				SetMapStat(unit_type, "HitPoints", 1, "Enable")
			end
			if (basic_damage_value:getText() ~= GetUnitTypeData(unit_type, "BasicDamage")) then
				SetMapStat(unit_type, "BasicDamage", basic_damage_value:getText(), "Value")
				SetMapStat(unit_type, "BasicDamage", basic_damage_value:getText(), "Max")
				SetMapStat(unit_type, "BasicDamage", 1, "Enable")
			end
			if (armor_value:getText() ~= GetUnitTypeData(unit_type, "Armor")) then
				SetMapStat(unit_type, "Armor", armor_value:getText(), "Value")
				SetMapStat(unit_type, "Armor", armor_value:getText(), "Max")
				SetMapStat(unit_type, "Armor", 1, "Enable")
			end
			if (accuracy_value:getText() ~= GetUnitTypeData(unit_type, "Accuracy")) then
				SetMapStat(unit_type, "Accuracy", accuracy_value:getText(), "Value")
				SetMapStat(unit_type, "Accuracy", accuracy_value:getText(), "Max")
				SetMapStat(unit_type, "Accuracy", 1, "Enable")
			end
			if (evasion_value:getText() ~= GetUnitTypeData(unit_type, "Evasion")) then
				SetMapStat(unit_type, "Evasion", evasion_value:getText(), "Value")
				SetMapStat(unit_type, "Evasion", evasion_value:getText(), "Max")
				SetMapStat(unit_type, "Evasion", 1, "Enable")
			end
			if (range_value:getText() ~= GetUnitTypeData(unit_type, "AttackRange")) then
				SetMapStat(unit_type, "AttackRange", range_value:getText(), "Value")
				SetMapStat(unit_type, "AttackRange", range_value:getText(), "Max")
				SetMapStat(unit_type, "AttackRange", 1, "Enable")
			end
			if (sight_value:getText() ~= GetUnitTypeData(unit_type, "SightRange")) then
				SetMapStat(unit_type, "SightRange", sight_value:getText(), "Value")
				SetMapStat(unit_type, "SightRange", sight_value:getText(), "Max")
				SetMapStat(unit_type, "SightRange", 1, "Enable")
			end
			if (speed_value:getText() ~= GetUnitTypeData(unit_type, "Speed")) then
				SetMapStat(unit_type, "Speed", speed_value:getText(), "Value")
				SetMapStat(unit_type, "Speed", speed_value:getText(), "Max")
				SetMapStat(unit_type, "Speed", 1, "Enable")
			end
			if (critical_strike_chance_value:getText() ~= GetUnitTypeData(unit_type, "CriticalStrikeChance")) then
				SetMapStat(unit_type, "CriticalStrikeChance", critical_strike_chance_value:getText(), "Value")
				SetMapStat(unit_type, "CriticalStrikeChance", critical_strike_chance_value:getText(), "Max")
				SetMapStat(unit_type, "CriticalStrikeChance", 1, "Enable")
			end
			if (backstab_value:getText() ~= GetUnitTypeData(unit_type, "Backstab")) then
				SetMapStat(unit_type, "Backstab", backstab_value:getText(), "Value")
				SetMapStat(unit_type, "Backstab", backstab_value:getText(), "Max")
				SetMapStat(unit_type, "Backstab", 1, "Enable")
			end
			if (bonus_against_mounted_value:getText() ~= GetUnitTypeData(unit_type, "BonusAgainstMounted")) then
				SetMapStat(unit_type, "BonusAgainstMounted", bonus_against_mounted_value:getText(), "Value")
				SetMapStat(unit_type, "BonusAgainstMounted", bonus_against_mounted_value:getText(), "Max")
				SetMapStat(unit_type, "BonusAgainstMounted", 1, "Enable")
			end
			if (thorns_damage_value:getText() ~= GetUnitTypeData(unit_type, "ThornsDamage")) then
				SetMapStat(unit_type, "ThornsDamage", thorns_damage_value:getText(), "Value")
				SetMapStat(unit_type, "ThornsDamage", thorns_damage_value:getText(), "Max")
				SetMapStat(unit_type, "ThornsDamage", 1, "Enable")
			end
			if (day_sight_range_bonus_value:getText() ~= GetUnitTypeData(unit_type, "DaySightRangeBonus")) then
				SetMapStat(unit_type, "DaySightRangeBonus", day_sight_range_bonus_value:getText(), "Value")
				SetMapStat(unit_type, "DaySightRangeBonus", day_sight_range_bonus_value:getText(), "Max")
				SetMapStat(unit_type, "DaySightRangeBonus", 1, "Enable")
			end
			if (night_sight_range_bonus_value:getText() ~= GetUnitTypeData(unit_type, "NightSightRangeBonus")) then
				SetMapStat(unit_type, "NightSightRangeBonus", night_sight_range_bonus_value:getText(), "Value")
				SetMapStat(unit_type, "NightSightRangeBonus", night_sight_range_bonus_value:getText(), "Max")
				SetMapStat(unit_type, "NightSightRangeBonus", 1, "Enable")
			end
			menu:stop()
		end
	)

	menu:addHalfButton(_("~!Cancel"), "c", 130 + 48, sizeY - 40,
		function() menu:stop() end)

	menu:run(false)
end

function EditUnitTypePropertiesResourceStats(unit_type)

	if (unit_type == "" or unit_type == nil) then
		return;
	end
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel(_(GetUnitTypeName(unit_type)) .. " " .. _("Properties"), sizeX / 2, 11)

	menu:addLabel(_("Time Cost:"), 10, 12 + 36 * 1, Fonts["game"], false)
	local time_cost_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Costs", "time"), (sizeX / 2) - 60 - 10, 11 + 36 * 1, 60)

	menu:addLabel(_("Gold Cost:"), (sizeX / 2) + 10, 12 + 36 * 1, Fonts["game"], false)
	local gold_cost_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Costs", "gold"), sizeX - 60 - 10, 11 + 36 * 1, 60)

	menu:addLabel(_("Lumber Cost:"), 10, 12 + 36 * 2, Fonts["game"], false)
	local lumber_cost_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Costs", "lumber"), (sizeX / 2) - 60 - 10, 11 + 36 * 2, 60)

	menu:addLabel(_("Stone Cost:"), (sizeX / 2) + 10, 12 + 36 * 2, Fonts["game"], false)
	local stone_cost_value = menu:addTextInputField(GetUnitTypeData(unit_type, "Costs", "stone"), sizeX - 60 - 10, 11 + 36 * 2, 60)

	menu:addLabel(_("Gold Proc.:"), 10, 12 + 36 * 3, Fonts["game"], false)
	local gold_processing_value = menu:addTextInputField(GetUnitTypeData(unit_type, "ImproveProduction", "gold"), (sizeX / 2) - 60 - 10, 11 + 36 * 3, 60)

	menu:addLabel(_("Lumber Proc.:"), (sizeX / 2) + 10, 12 + 36 * 3, Fonts["game"], false)
	local lumber_processing_value = menu:addTextInputField(GetUnitTypeData(unit_type, "ImproveProduction", "lumber"),  sizeX - 60 - 10, 11 + 36 * 3, 60)

	menu:addLabel(_("Stone Proc.:"), 10, 12 + 36 * 4, Fonts["game"], false)
	local stone_processing_value = menu:addTextInputField(GetUnitTypeData(unit_type, "ImproveProduction", "stone"), (sizeX / 2) - 60 - 10, 11 + 36 * 4, 60)

	menu:addHalfButton(_("~!OK"), "o", 20 + 48, sizeY - 40,
		function()
			if (time_cost_value:getText() ~= GetUnitTypeData(unit_type, "Costs", "time")) then
				SetMapStat(unit_type, "Costs", time_cost_value:getText(), "time")
			end
			if (gold_cost_value:getText() ~= GetUnitTypeData(unit_type, "Costs", "gold")) then
				SetMapStat(unit_type, "Costs", gold_cost_value:getText(), "gold")
			end
			if (lumber_cost_value:getText() ~= GetUnitTypeData(unit_type, "Costs", "lumber")) then
				SetMapStat(unit_type, "Costs", lumber_cost_value:getText(), "lumber")
			end
			if (stone_cost_value:getText() ~= GetUnitTypeData(unit_type, "Costs", "stone")) then
				SetMapStat(unit_type, "Costs", stone_cost_value:getText(), "stone")
			end
			if (gold_processing_value:getText() ~= GetUnitTypeData(unit_type, "ImproveProduction", "gold")) then
				SetMapStat(unit_type, "ImproveProduction", gold_processing_value:getText(), "gold")
			end
			if (lumber_processing_value:getText() ~= GetUnitTypeData(unit_type, "ImproveProduction", "lumber")) then
				SetMapStat(unit_type, "ImproveProduction", lumber_processing_value:getText(), "lumber")
			end
			if (stone_processing_value:getText() ~= GetUnitTypeData(unit_type, "ImproveProduction", "stone")) then
				SetMapStat(unit_type, "ImproveProduction", stone_processing_value:getText(), "stone")
			end
			menu:stop()
		end
	)

	menu:addHalfButton(_("~!Cancel"), "c", 130 + 48, sizeY - 40,
		function() menu:stop() end)

	menu:run(false)
end

function EditUnitTypePropertiesSounds(unit_type)

	if (unit_type == "" or unit_type == nil) then
		return;
	end
	local menu = WarGameMenu(panel(5))
	local sizeX = 352
	local sizeY = 352

	menu:resize(sizeX, sizeY)
	menu:addLabel(_(GetUnitTypeName(unit_type)) .. " " .. _("Properties"), sizeX / 2, 11)

	local sound_list = GetSounds()
	table.insert(sound_list, "") -- for instances where the unit does not have a sound of a particular type
  
	menu:addLabel(_("Selected:"), 10, 14 + 36 * 1, Fonts["game"], false)
	local selected_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 1, function(dd) end)
	selected_sound:setSize(236, 20)
	selected_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "selected")) - 1)
	
	menu:addLabel(_("Acknowledge:"), 10, 14 + 36 * 2, Fonts["game"], false)
	local acknowledge_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 2, function(dd) end)
	acknowledge_sound:setSize(236, 20)
	acknowledge_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "acknowledge")) - 1)
	
	menu:addLabel(_("Attack:"), 10, 14 + 36 * 3, Fonts["game"], false)
	local attack_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 3, function(dd) end)
	attack_sound:setSize(236, 20)
	attack_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "attack")) - 1)
	
	menu:addLabel(_("Ready:"), 10, 14 + 36 * 4, Fonts["game"], false)
	local ready_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 4, function(dd) end)
	ready_sound:setSize(236, 20)
	ready_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "ready")) - 1)
	
	menu:addLabel(_("Idle:"), 10, 14 + 36 * 5, Fonts["game"], false)
	local idle_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 5, function(dd) end)
	idle_sound:setSize(236, 20)
	idle_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "idle")) - 1)
	
	menu:addLabel(_("Help:"), 10, 14 + 36 * 6, Fonts["game"], false)
	local help_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 6, function(dd) end)
	help_sound:setSize(236, 20)
	help_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "help")) - 1)
	
	menu:addLabel(_("Dead:"), 10, 14 + 36 * 7, Fonts["game"], false)
	local dead_sound = menu:addDropDown(sound_list, (sizeX / 2) - 60 - 10, 11 + 36 * 7, function(dd) end)
	dead_sound:setSize(236, 20)
	dead_sound:setSelected(GetElementIndexFromArray(sound_list, GetUnitTypeData(unit_type, "Sounds", "dead")) - 1)
	
	menu:addHalfButton("~!OK", "o", 20 + 48, sizeY - 40,
		function()
			if (sound_list[selected_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "selected")) then
				SetMapSound(unit_type, sound_list[selected_sound:getSelected() + 1], "selected")
			end
			if (sound_list[acknowledge_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "acknowledge")) then
				SetMapSound(unit_type, sound_list[acknowledge_sound:getSelected() + 1], "acknowledge")
			end
			if (sound_list[attack_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "attack")) then
				SetMapSound(unit_type, sound_list[attack_sound:getSelected() + 1], "attack")
			end
			if (sound_list[ready_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "ready")) then
				SetMapSound(unit_type, sound_list[ready_sound:getSelected() + 1], "ready")
			end
			if (sound_list[idle_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "idle")) then
				SetMapSound(unit_type, sound_list[idle_sound:getSelected() + 1], "idle")
			end
			if (sound_list[help_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "help")) then
				SetMapSound(unit_type, sound_list[help_sound:getSelected() + 1], "help")
			end
			if (sound_list[dead_sound:getSelected() + 1] ~= GetUnitTypeData(unit_type, "Sounds", "dead")) then
				SetMapSound(unit_type, sound_list[dead_sound:getSelected() + 1], "dead")
			end
			menu:stop()
		end
	)

	menu:addHalfButton(_("~!Cancel"), "c", 130 + 48, sizeY - 40,
		function() menu:stop() end)

	menu:run(false)
end
